# @configure_input@

# Package-specific substitution variables
package = @PACKAGE_NAME@
version = @PACKAGE_VERSION@
tarname = @PACKAGE_TARNAME@
distdir = $(tarname)-$(version)

# Prefix-specific subtitution variables
prefix = @prefix@
lib_prefix = @lib_prefix@
libdir = @libdir@

# VPATH-related substituion variables
srcdir = @srcdir@
VPATH = @srcdir@

CC := gcc
CFLAGS ?= -std=c99 -O0 -Wall -Wextra -Wpedantic -g3 -fPIC
CPPFLAGS ?= 
LDFLAGS ?= -L. -L$(srcdir) -L.. -lddtable
DEFINES ?= 
INCLUDES ?= -I. -I$(srcdir) -I.. # Order matters

# Ctags flags
CTAGS_FLAGS := -e -f TAGS --verbose -R --exclude=doc --langmap=c:.c.h --fields="+afikKlmnsSzt"

SOURCES := ddtable.c spooky-c.c ddtable_test.c
OBJECTS = $(SOURCES:%.c=%.o)
BINARY := ddtable_test.bin
LIB := libddtable.so

.PHONY: all build rebuild clean run ctags check install uninstall

Makefile: Makefile.in ../config.status
	cd .. && ./config.status src/$@

./config.status: ../configure
	cd .. && ./config.status --recheck

all: build

build: $(LIB) $(BINARY)

clean:
	$(RM) $(OBJECTS) $(LIB) $(BINARY)

rebuild: clean build

$(OBJECTS): %.o : %.c
	$(CC) $(INCLUDES) $(CPPFLAGS) $(CFLAGS) $(DEFINES) -o $@ -c $<

$(BINARY): $(BINARY:%.bin=%.o) $(LIB)
	$(CC) $^ -o $@ $(LDFLAGS)

$(LIB): $(OBJECTS)
	$(CC) -shared $^ -o $@

run: $(BINARY)
	./$(BINARY)

check: all
	./$(BINARY) == 0
	@echo "*** ALL TESTS PASSED ***"

install: $(LIB)
	install -d $(DESTDIR)$(libdir)
	install -m 0755 $(DESTDIR)$(LIB) $(libdir)

uninstall:
	-rm $(DESTDIR)$(libdir)/$(LIB)

ctags:
	ctags $(CTAGS_FLAGS)


